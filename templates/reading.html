<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>阅读工作台 - 智能教材语料生成平台</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/reading.css">
    <!-- MathJax for LaTeX rendering -->
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>
</head>

<body>
    <div class="reading-container">
        <!-- Sidebar with chapter navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="header-top">
                    <h3 id="bookTitle">Loading...</h3>
                    <div class="header-links">
                        <a href="/" class="btn-back" title="返回首页">← 返回</a>
                        <a href="/content_manager/{{ book_id }}" class="btn-icon-link" title="内容管理">
                            <span class="icon">📋</span>
                        </a>
                    </div>
                </div>
                <div class="header-controls">
                    <label class="checkbox-label">
                        <input type="checkbox" id="selectAllChapters">
                        全选
                    </label>
                    <span id="selectedCount" class="selected-count" style="display: none;">已选 0 项</span>
                </div>
            </div>
            <div class="chapter-tree" id="chapterTree">
                <!-- Chapters will be loaded here -->
            </div>
        </aside>

        <!-- Main content area -->
        <main class="content-area">
            <!-- Chapter content -->
            <div class="chapter-display" id="chapterDisplay">
                <div class="chapter-header">
                    <h2 id="chapterTitle">Select a chapter</h2>
                    <div class="chapter-meta">
                        <span id="chapterTokens" class="token-count">0 tokens</span>
                        <button id="splitChapterBtn" class="btn btn-warning btn-small" style="display: none;">
                            <span class="icon">✂️</span>
                            切分章节
                        </button>
                    </div>
                </div>
                <div id="chapterContent" class="markdown-content">
                    <!-- Markdown content will be rendered here -->
                </div>
            </div>
        </main>

        <!-- Right control panel -->
        <aside class="control-panel">
            <div class="panel-header">
                <h3>生成控制台</h3>
            </div>

            <!-- Combined Control Card -->
            <div class="control-card">
                <div class="control-section">
                    <div class="form-group">
                        <label>选择模型</label>
                        <select id="modelSelect" class="full-width">
                            <!-- Options loaded via JS -->
                        </select>
                        <div id="contextUsage" class="context-usage-info" style="display: none;">
                            <span class="usage-text"></span>
                            <div class="usage-bar">
                                <div class="usage-fill"></div>
                            </div>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <div class="control-section">
                        <label class="section-label">生成设置</label>
                        <div class="control-row">
                            <div class="count-input-wrapper">
                                <span class="input-label">数量</span>
                                <input type="number" id="generateCount" value="8" min="1" max="20" class="count-input">
                            </div>
                            <button id="viewPrompt" class="btn-icon-text" title="编辑 Prompt">
                                <span class="icon">⚙️</span> 模板
                            </button>
                        </div>
                    </div>

                    <div class="control-section">
                        <div class="button-grid">
                            <button id="generateQaBtn" class="btn primary large-btn">
                                <span class="icon">❓</span> 生成问答
                            </button>
                            <button id="generateExerciseBtn" class="btn primary large-btn">
                                <span class="icon">📝</span> 生成习题
                            </button>
                        </div>
                    </div>

                    <div id="generationStatus" class="status-message"></div>

                    <!-- Batch Generation Progress - Enhanced Display -->
                    <div id="batchProgress" style="display: none;">
                        <div class="batch-progress-container">
                            <div class="batch-progress-header">
                                <span class="progress-icon">⚡</span>
                                <span>批量生成进行中...</span>
                            </div>
                            <div class="batch-progress-detail" id="batchProgressDetail">
                                准备开始...
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="batchProgressFill" style="width: 0%"></div>
                                </div>
                                <div class="progress-text" id="batchProgressText">0/0</div>
                            </div>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <!-- Verification Progress (Moved here) -->
                    <div class="control-section" id="verificationProgressSection" style="display: none;">
                        <label class="section-label">校验进度</label>
                        <div class="progress-bar-container">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                            </div>
                            <div class="progress-text" id="progressText">0 / 0 (0%)</div>
                        </div>
                    </div>

                </div>

                <div class="control-card">
                    <a href="/content_manager/{{ book_id }}" class="btn secondary full-width btn-content-manager">
                        <span class="icon">📊</span> 内容管理
                    </a>
                </div>
        </aside>
    </div>

    <!-- Split Chapter Confirmation Modal -->
    <div id="splitModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>切分章节确认</h3>
            <p>当前章节包含 <strong id="splitTokenCount">0</strong> tokens，将根据所选模型的token限制进行切分。</p>
            <div class="form-group">
                <label for="splitModelSelect">选择目标模型</label>
                <select id="splitModelSelect" class="model-select">
                    <!-- Models will be loaded dynamically -->
                </select>
            </div>
            <p class="hint">切分后原章节将被替换为多个较小的子章节。</p>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeSplitModal()">取消</button>
                <button type="button" class="btn btn-warning" onclick="confirmSplit()">确认切分</button>
            </div>
        </div>
    </div>

    <!-- Prompt Editor Modal -->
    <div id="promptModal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
            <h3>Prompt 模板编辑</h3>
            <div class="prompt-tabs">
                <button class="tab-btn active" data-type="qa">问答对模板</button>
                <button class="tab-btn" data-type="exercise">习题模板</button>
            </div>
            <textarea id="promptEditor" rows="15" class="prompt-editor"></textarea>
            <p class="hint">模板中可使用占位符: {chapter_title}, {chapter_content}, {count} (生成数量)</p>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closePromptModal()">取消</button>
                <button type="button" class="btn btn-primary" onclick="savePrompt()">保存修改</button>
            </div>
        </div>
    </div>

    <script src="/static/js/reading.js"></script>
</body>

</html>