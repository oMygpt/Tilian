<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜…è¯»å·¥ä½œå° - æ™ºèƒ½æ•™æè¯­æ–™ç”Ÿæˆå¹³å°</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/reading.css">
    <!-- MathJax for LaTeX rendering -->
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>
</head>

<body>
    <div class="reading-container">
        <!-- Sidebar with chapter navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="header-top">
                    <h3 id="bookTitle">{{ _('Loading...') }}</h3>
                    <div class="header-links">
                        <a href="/" class="btn-back" title="{{ _('è¿”å›é¦–é¡µ') }}">â† {{ _('è¿”å›') }}</a>
                        <a href="/content_manager/{{ book_id }}" class="btn-icon-link" title="{{ _('å†…å®¹ç®¡ç†') }}">
                            <span class="icon">ğŸ“‹</span>
                        </a>
                    </div>
                </div>
                <div class="header-controls">
                    <label class="checkbox-label">
                        <input type="checkbox" id="selectAllChapters">
                        {{ _('å…¨é€‰') }}
                    </label>
                    <span id="selectedCount" class="selected-count" style="display: none;">{{ _('å·²é€‰ 0 é¡¹') }}</span>
                </div>
            </div>
            <div class="chapter-tree" id="chapterTree">
                <!-- Chapters will be loaded here -->
            </div>
        </aside>

        <!-- Main content area -->
        <main class="content-area">
            <!-- Chapter content -->
            <div class="chapter-display" id="chapterDisplay">
                <div class="chapter-header">
                    <h2 id="chapterTitle">{{ _('Select a chapter') }}</h2>
                    <div class="chapter-meta">
                        <span id="chapterTokens" class="token-count">0 tokens</span>
                        <button id="splitChapterBtn" class="btn btn-warning btn-small" style="display: none;">
                            <span class="icon">âœ‚ï¸</span>
                            {{ _('åˆ‡åˆ†ç« èŠ‚') }}
                        </button>
                    </div>
                </div>
                <div id="chapterContent" class="markdown-content">
                    <!-- Markdown content will be rendered here -->
                </div>
            </div>
        </main>

        <!-- Right control panel -->
        <aside class="control-panel">
            <div class="panel-header">
                <h3>{{ _('ç”Ÿæˆæ§åˆ¶å°') }}</h3>
            </div>

            <!-- Combined Control Card -->
            <div class="control-card">
                <div class="control-section">
                    <div class="form-group">
                        <label>{{ _('é€‰æ‹©æ¨¡å‹') }}</label>
                        <select id="modelSelect" class="full-width">
                            <!-- Options loaded via JS -->
                        </select>
                        <div id="contextUsage" class="context-usage-info" style="display: none;">
                            <span class="usage-text"></span>
                            <div class="usage-bar">
                                <div class="usage-fill"></div>
                            </div>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <div class="control-section">
                        <label class="section-label">{{ _('ç”Ÿæˆè®¾ç½®') }}</label>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label class="input-label" style="display: block; margin-bottom: 5px;">{{ _('ç”Ÿæˆæ¨¡å¼')
                                }}</label>
                            <select id="generationMode" class="full-width">
                                <option value="standard">{{ _('æ ‡å‡†æ¨¡å¼ (å¿«é€Ÿ)') }}</option>
                                <option value="multi_agent">{{ _('å¤šæ™ºèƒ½ä½“åä½œ (é«˜è´¨é‡)') }}</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <div class="count-input-wrapper">
                                <span class="input-label">{{ _('æ•°é‡') }}</span>
                                <input type="number" id="generateCount" value="8" min="1" max="20" class="count-input">
                            </div>
                            <button id="viewPrompt" class="btn-icon-text" title="{{ _('ç¼–è¾‘ Prompt') }}">
                                <span class="icon">âš™ï¸</span> {{ _('æ¨¡æ¿') }}
                            </button>
                        </div>
                    </div>

                    <div class="control-section">
                        <div class="button-grid">
                            <button id="generateQaBtn" class="btn primary large-btn">
                                <span class="icon">â“</span> {{ _('ç”Ÿæˆé—®ç­”') }}
                            </button>
                            <button id="generateExerciseBtn" class="btn primary large-btn">
                                <span class="icon">ğŸ“</span> {{ _('ç”Ÿæˆä¹ é¢˜') }}
                            </button>
                        </div>
                    </div>

                    <div id="generationStatus" class="status-message"></div>

                    <!-- Batch Generation Progress - Enhanced Display -->
                    <div id="batchProgress" style="display: none;">
                        <div class="batch-progress-container">
                            <div class="batch-progress-header">
                                <span class="progress-icon">âš¡</span>
                                <span>{{ _('æ‰¹é‡ç”Ÿæˆè¿›è¡Œä¸­...') }}</span>
                            </div>
                            <div class="batch-progress-detail" id="batchProgressDetail">
                                {{ _('å‡†å¤‡å¼€å§‹...') }}
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="batchProgressFill" style="width: 0%"></div>
                                </div>
                                <div class="progress-text" id="batchProgressText">0/0</div>
                            </div>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <!-- Verification Progress (Moved here) -->
                    <div class="control-section" id="verificationProgressSection" style="display: none;">
                        <label class="section-label">{{ _('æ ¡éªŒè¿›åº¦') }}</label>
                        <div class="progress-bar-container">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                            </div>
                            <div class="progress-text" id="progressText">0 / 0 (0%)</div>
                        </div>
                    </div>

                </div>

                <div class="control-card">
                    <a href="/content_manager/{{ book_id }}" class="btn secondary full-width btn-content-manager">
                        <span class="icon">ğŸ“Š</span> {{ _('å†…å®¹ç®¡ç†') }}
                    </a>
                </div>
        </aside>
    </div>

    <!-- Split Chapter Confirmation Modal -->
    <div id="splitModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>{{ _('åˆ‡åˆ†ç« èŠ‚ç¡®è®¤') }}</h3>
            <p>{{ _('å½“å‰ç« èŠ‚åŒ…å«') }} <strong id="splitTokenCount">0</strong> tokensï¼Œ{{ _('å°†æ ¹æ®æ‰€é€‰æ¨¡å‹çš„tokené™åˆ¶è¿›è¡Œåˆ‡åˆ†ã€‚') }}</p>
            <div class="form-group">
                <label for="splitModelSelect">{{ _('é€‰æ‹©ç›®æ ‡æ¨¡å‹') }}</label>
                <select id="splitModelSelect" class="model-select">
                    <!-- Models will be loaded dynamically -->
                </select>
            </div>
            <p class="hint">{{ _('åˆ‡åˆ†ååŸç« èŠ‚å°†è¢«æ›¿æ¢ä¸ºå¤šä¸ªè¾ƒå°çš„å­ç« èŠ‚ã€‚') }}</p>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeSplitModal()">{{ _('å–æ¶ˆ') }}</button>
                <button type="button" class="btn btn-warning" onclick="confirmSplit()">{{ _('ç¡®è®¤åˆ‡åˆ†') }}</button>
            </div>
        </div>
    </div>

    <!-- Prompt Editor Modal -->
    <div id="promptModal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
            <h3>{{ _('Prompt æ¨¡æ¿ç¼–è¾‘') }}</h3>
            <div class="prompt-tabs">
                <button class="tab-btn active" data-type="qa">{{ _('é—®ç­”å¯¹æ¨¡æ¿') }}</button>
                <button class="tab-btn" data-type="exercise">{{ _('ä¹ é¢˜æ¨¡æ¿') }}</button>
            </div>
            <textarea id="promptEditor" rows="15" class="prompt-editor"></textarea>
            <p class="hint">{{ _('æ¨¡æ¿ä¸­å¯ä½¿ç”¨å ä½ç¬¦: {chapter_title}, {chapter_content}, {count} (ç”Ÿæˆæ•°é‡)') }}</p>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closePromptModal()">{{ _('å–æ¶ˆ') }}</button>
                <button type="button" class="btn btn-primary" onclick="savePrompt()">{{ _('ä¿å­˜ä¿®æ”¹') }}</button>
            </div>
        </div>
    </div>

    </div>

    <script>
        window.translations = {{ js_translations | tojson }};
        window.t = function (key, params) {
            let text = window.translations[key] || key;
            if (params) {
                for (let k in params) {
                    text = text.replace('{' + k + '}', params[k]);
                }
            }
            return text;
        };
    </script>
    <script src="/static/js/reading.js"></script>
</body>

</html>